{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["/* eslint-disable no-console */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript main event handler.\n *\n * @module     tool/inplacetranslate\n * @copyright  2024 Devlionco <info@devlion.co>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      4.1\n */\n\nimport { call as fetchMany } from 'core/ajax';\nimport { exception as displayException } from 'core/notification';\nimport Templates from 'core/templates';\nimport { debounce } from 'core/utils';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport { get_string as getString } from 'core/str';\n\nconst DEBOUNCE_TIMER = 500;\n\nlet oldTranslate;\n\nconst Selectors = {\n    targets: {\n        menu: 'inplacetranslate_menu',\n        menuToggler: 'inplacetranslate_menu_toggler',\n        search: 'inplacetranslate_search',\n        clearSearchBtn: 'inplacetranslate_clear_search_btn',\n        items: 'inplacetranslate-item',\n        translatesForm: 'translates_form'\n    },\n    elements: {}\n};\n\n/**\n * Initialize selectors.\n */\nconst initSelectors = () => {\n    Selectors.elements.menu = document.getElementById(Selectors.targets.menu);\n    Selectors.elements.menuToggler = document.getElementById(Selectors.targets.menuToggler);\n    Selectors.elements.search = document.getElementById(Selectors.targets.search);\n    Selectors.elements.clearSearchBtn = document.getElementById(Selectors.targets.clearSearchBtn);\n    Selectors.elements.items = document.querySelectorAll('.' + Selectors.targets.items);\n};\n\n/**\n * Get translate.\n * @param {string} query Search query.\n * @returns {any} strings data.\n */\nconst getTranslate = (query) => fetchMany([{\n    methodname: 'tool_inplacetranslate_get_translated_string',\n    args: {\n        query: query\n    }\n}])[0];\n\n/**\n * Save translate strings.\n * @param {string} identifier Translated string.\n * @param {string} translateJson JSON example {string: 'some text', lang: 'en'}.\n * @returns {any} strings data.\n */\n\nconst setTranslate = (identifier, translateJson) => fetchMany([{\n    methodname: 'tool_inplacetranslate_set_translated_string',\n    args: {\n        identifier: identifier,\n        translateJson: translateJson\n    }\n}])[0];\n\nconst clearSearch = () => {\n    Selectors.elements.search.value = '';\n    Selectors.elements.items.forEach((element) => {\n        element.closest('li').classList.add('d-flex');\n        element.closest('li').classList.remove('d-none');\n    });\n};\n\nconst showClearSearchBtn = () => {\n    Selectors.elements.clearSearchBtn.classList.remove('d-none');\n};\n\nconst hideClearSearchBtn = () => {\n    Selectors.elements.clearSearchBtn.classList.add('d-none');\n};\n\nconst showSearchResult = (searchQuery) => {\n    const htmlRegex = /(<([^>]+)>)/gi;\n    Selectors.elements.items.forEach((element) => {\n        const text = element.innerHTML.replace(htmlRegex, ' ').trim().toLowerCase();\n        const dataset = element.dataset.translate.replace(htmlRegex, ' ').trim().toLowerCase();\n        if (text.includes(searchQuery) || dataset.includes(searchQuery)) {\n            element.closest('li').classList.add('d-flex');\n            element.closest('li').classList.remove('d-none');\n        } else {\n            element.closest('li').classList.remove('d-flex');\n            element.closest('li').classList.add('d-none');\n        }\n    });\n};\n\nexport const init = () => {\n    initSelectors();\n    document.onclick = (event) => {\n        if (event.target.closest('.inplacetranslate-item')) {\n            const element = event.target.closest('.inplacetranslate-item');\n            const identifier = element.dataset.id.toString();\n            oldTranslate = event.target.closest('.inplacetranslate-item').dataset.translate;\n            // activeString = element.querySelector('.translate').innerText;\n            getTranslate(identifier).then(result => showModal(result)).catch((error) => displayException(error));\n        }\n    };\n\n    Selectors.elements.clearSearchBtn.onclick = () => {\n        clearSearch();\n        hideClearSearchBtn();\n    };\n    Selectors.elements.menuToggler.onclick = () => {\n        if (Selectors.elements.menuToggler.classList.contains('shown')) {\n            Selectors.elements.menuToggler.classList.remove('shown');\n            document.body.classList.add('inplacetranslate-menu-shown');\n        } else {\n            Selectors.elements.menuToggler.classList.add('shown');\n            document.body.classList.remove('inplacetranslate-menu-shown');\n        }\n    };\n    Selectors.elements.search.addEventListener('keyup', debounce((event) => {\n        event.preventDefault();\n        const searchQuery = event.target.value.toString().toLowerCase().trim();\n        showSearchResult(searchQuery);\n        showClearSearchBtn();\n    }, DEBOUNCE_TIMER));\n};\n\nconst showAlert = () => {\n    getString('stringwasupdated', 'tool_inplacetranslate', oldTranslate)\n        .then((str) => {\n            const alertElement = document.createElement('div');\n            alertElement.classList.add('position-fixed', 'alert', 'alert-success', 'alert-dismissible', 'p-3', 'fade', 'show');\n            alertElement.setAttribute('role', 'alert');\n            alertElement.setAttribute('style', 'top: 15vh; left: 32vw;position: fixed; z-index: 100;');\n\n\n            // Create the close button element\n            const closeButton = document.createElement('button');\n            closeButton.classList.add('close');\n            closeButton.setAttribute('type', 'button');\n            closeButton.setAttribute('data-dismiss', 'alert');\n\n            // Create the span element inside the close button\n            const closeSpan = document.createElement('span');\n            closeSpan.setAttribute('aria-hidden', 'true');\n            closeSpan.textContent = 'Ã—';\n\n            // Append the elements\n            closeButton.appendChild(closeSpan);\n            alertElement.appendChild(document.createTextNode(str));\n            alertElement.appendChild(closeButton);\n\n            // Append the alert element to the body\n            return document.body.appendChild(alertElement);\n        }).catch((error) => displayException(error));\n\n};\n\n/* const findElementsWithText = (result) => {\n    const lowercaseQuery = oldTranslate.toLowerCase();\n\n    const treeWalker = document.createTreeWalker(\n        document.body,\n        NodeFilter.SHOW_TEXT,\n    );\n\n\n    let currentNode = treeWalker.nextNode();\n    let matchingElement;\n\n    // Iterate through all text nodes\n    while (currentNode) {\n        const parentElement = currentNode.parentElement;\n        const nodeText = currentNode.textContent.toLowerCase().trim();\n\n        // Check if the text content of the node is equal to the query\n        if (nodeText === lowercaseQuery) {\n            // If the parent element is not already in the list, add it\n            matchingElement = parentElement;\n            let text = matchingElement.innerText;\n            matchingElement.style.boxShadow = \"inset 0 0 30px yellow\";\n            matchingElement.innerText = text.replace(oldTranslate, newTranslate);\n            if (!parentElement.closest('#' + Selectors.targets.menu)) {\n                matchingElement.focus();\n                matchingElement.scrollIntoView();\n            }\n        }\n        currentNode = treeWalker.nextNode();\n    }\n    setTimeout(() => {\n        matchingElement.style.boxShadow = 'none';\n    }, 2000);\n}; */\n\nconst saveTranslate = (form) => {\n    const identifier = form.dataset.id;\n    const data = [];\n    const text = form.querySelectorAll('textarea');\n    // const currentLang = form.dataset.current;\n    text.forEach((el) => {\n        data.push({ string: el.value.trim(), lang: el.dataset.lang.toLowerCase() });\n        /*        if (el.dataset.lang.toLowerCase() === currentLang) {\n                   newTranslate = el.value.trim();\n               } */\n    });\n    setTranslate(identifier, JSON.stringify(data)).then(() => showAlert())\n        .catch((error) => displayException(error));\n};\n\nconst showModal = async (data) => {\n    const templateContext = JSON.parse(data);\n    const modal = await ModalFactory.create({\n        type: ModalFactory.types.SAVE_CANCEL,\n        large: true,\n        title: getString('setnewtranslate', 'tool_inplacetranslate'),\n        body: Templates.render('tool_inplacetranslate/stringmodal', templateContext),\n    });\n    modal.show();\n    modal.getRoot().on(ModalEvents.save, () => {\n        const form = modal.getBody()[0].querySelector('#' + Selectors.targets.translatesForm);\n        saveTranslate(form);\n        modal.destroy();\n    });\n};"],"names":["_interopRequireDefault","obj","__esModule","default","_templates","_modal_factory","_modal_events","oldTranslate","Selectors","targets","menu","menuToggler","search","clearSearchBtn","items","translatesForm","elements","_exports","init","document","getElementById","querySelectorAll","onclick","event","target","closest","identifier","dataset","id","toString","translate","query","fetchMany","methodname","args","then","result","showModal","catch","error","displayException","value","forEach","element","classList","add","remove","contains","body","addEventListener","debounce","preventDefault","searchQuery","htmlRegex","text","innerHTML","replace","trim","toLowerCase","includes","showSearchResult","saveTranslate","form","data","el","push","string","lang","setTranslate","translateJson","JSON","stringify","getString","str","alertElement","createElement","setAttribute","closeButton","closeSpan","textContent","appendChild","createTextNode","async","templateContext","parse","modal","ModalFactory","create","type","types","SAVE_CANCEL","large","title","Templates","render","show","getRoot","on","ModalEvents","save","getBody","querySelector","destroy"],"mappings":"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"}