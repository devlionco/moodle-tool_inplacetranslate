define(["jquery","core/str","core/ajax","theme_boost/popover"],function(t,n,e){let o;function a(){t(document).on("click",".edit-translation",function(n){n.preventDefault();let a=t(this),i=a.data("string");e.call([{methodname:"tool_inplacetranslate_translation_get_string",args:{identifier:i},done:function(n){var e=JSON.parse(n);!function(n,e){let a=n.data("string");t(".edit-translation").popover("dispose");let i=`<div class="popover" role="button">\n                <div class="arrow"></div>\n                <h3 class="popover-header"></h3>\n                <div class="popover-body"></div>\n                <div class="popover-footer text-center">\n                    <button type="button" class="popover-translation-close btn btn-default mr-1">${o[1]}</button><button type="button" class="popover-translation-update btn btn-primary mr-1" data-string="${a}">${o[2]}</button>\n                </div>\n            </div>`,r=`<div class="popover-translation-wrapper">\n                <div class="popover-translation-string">${e}</div>\n            </div>\n            `;t.fn.popover.Constructor.Default.whiteList.button=["data-string"],t.fn.popover.Constructor.Default.whiteList.span=["contenteditable"],t(n).popover({container:"body",content:r,template:i,placement:"top",title:o[3],html:!0}),n.popover("show")}(a,e.string)},fail:Notification.exception}])}),t(document).on("click",".popover-translation-close",function(n){n.preventDefault(),t(".edit-translation").popover("dispose")}),t(document).on("click",".popover-translation-update",function(n){n.preventDefault();let o=t(this).parents(".popover"),a=o.find(".popover-translation-string").html(),i=t(this).data("string");e.call([{methodname:"tool_inplacetranslate_translation_update_string",args:{string:a,identifier:i},done:function(t){var n=JSON.parse(t);0==n.error&&(o.find(".popover-body").html(n.response),o.find(".popover-footer").slideUp())},fail:Notification.exception}])})}return{init:function(){n.get_strings([{key:"edit",component:"tool_inplacetranslate"},{key:"cancel",component:"tool_inplacetranslate"},{key:"update",component:"tool_inplacetranslate"},{key:"translate_string",component:"tool_inplacetranslate"}]).then(function(n){o=n,t(document).ready(function(){const n=/{((.*?)\/(.*?))}/gm;let e,i=t("body").html(),r=[],l=[];for(;null!==(e=n.exec(i));){e.index===n.lastIndex&&n.lastIndex++,e.forEach((t,n)=>{});let a=t(":contains("+e[0]+")");if(0==a.length){let t=new RegExp('(?![aria\\-label])([a-zA-Z0-9_-]+)="(((?!").)+?){'+e[1]+'}"',"gm"),n=i.match(t);n&&n.length&&n.forEach(t=>{l.includes(t)||(l.push(t),r.push([e[3],t]))})}else{let n=a[a.length-1];if(!t(n).hasClass("addedtrtool")){let a=new RegExp("{"+e[1]+"}","gm"),i=e[0]+'<span class="edit-translation textem" data-string="'+e[1]+'">'+o[0]+"</span>";t(n).html(t(n).html().replace(a,i)),t(n).addClass("addedtrtool")}}}r.forEach(function(n){let e=n[1],a=t("["+e+"]:visible");a.length&&a.each(function(e,a){t(a).after('<span class="edit-translation" data-string="'+n[0]+'">'+o[0]+"</span>")})}),a()})}).catch()}}});